<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="utf-8" />
    <title>Ruleta Europea - Dise√±o Personalizado</title>
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: linear-gradient(to bottom, #0a2e15, #061c0c);
            --txt: #f0f0f0;
            --gold: #d4af37;
            --gold-dark: #b8860b;
            --shadow: 0 6px 15px rgba(0,0,0,.5);
            --red: #d32f2f;
            --black: #1a1a1a;
            --green: #2e7d32;
            --ok: #66bb6a;
            --warn: #ffa726;
            --err: #ef5350;
            --table-bg: #004d40;
            --table-border: #a47d2f;
        }
        * { box-sizing: border-box; margin: 0; padding: 0 }
        body {
            display: flex; flex-direction: column; align-items: center;
            background: var(--bg); color: var(--txt);
            font-family: 'Poppins', system-ui, Segoe UI, Roboto, Arial, sans-serif;
            padding: 16px; min-height: 100vh;
        }
        h1 {
            font-size: 2.5em;
            color: var(--gold);
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
        }
        h3 { margin: .5em 0; color: var(--gold); border-bottom: 1px solid var(--gold-dark); padding-bottom: 5px; }
        .row { display: flex; gap: 12px; flex-wrap: wrap; justify-content: center; align-items: center }
        select, button {
            padding: 10px 18px; font-size: 16px; font-weight: 600;
            border: none; border-radius: 8px;
            font-family: 'Poppins', sans-serif;
        }
        button {
            cursor: pointer;
            background: linear-gradient(145deg, var(--gold), var(--gold-dark));
            color: #111;
            margin: 4px;
            box-shadow: var(--shadow);
            transition: all .15s ease-out;
            border-bottom: 2px solid var(--gold-dark);
        }
        button:hover { transform: translateY(-2px); box-shadow: 0 8px 20px rgba(0,0,0,.6); }
        button:active { transform: translateY(1px); box-shadow: 0 2px 8px rgba(0,0,0,.5); }
        button.secondary { background: linear-gradient(145deg, #444, #222); color: #fff; border-bottom: 2px solid #111;}
        button.ghost { background: transparent; border: 2px solid var(--gold-dark); color: var(--gold); }
        button:disabled { opacity: .5; cursor: not-allowed; background: #555; transform: none; box-shadow: none; }
        .wrap { display: none; width: 100%; max-width: 1300px; margin-top: 12px; }
        .top-wrap { display: flex; gap: 18px; flex-wrap: wrap; justify-content: center; }
        .ruleta-panel {
            flex: 1; min-width: 320px; background: rgba(0,0,0,0.2); backdrop-filter: blur(10px);
            border-radius: 16px; padding: 16px; box-shadow: var(--shadow); text-align: center;
            border: 1px solid rgba(212, 175, 55, 0.2);
        }
        .ruleta-area {
            display: flex; align-items: center; justify-content: center;
            gap: 40px; flex-wrap: wrap; margin-bottom: 20px;
        }
        canvas {
            border-radius: 50%;
            box-shadow: 0 0 40px rgba(255, 215, 0, 0.3), 0 0 60px rgba(0,0,0,0.8);
            width: 450px; height: 450px; display: block;
        }
        .croupier-display {
            display: none; text-align: center;
        }
        #croupierImage {
            width: 180px; height: 180px; border-radius: 50%;
            border: 5px solid var(--gold); box-shadow: var(--shadow);
            object-fit: cover;
        }
        .status { display: flex; gap: 16px; justify-content: center; margin-top: 6px; font-size: 20px; }
        #saldo, #totalApuesta { font-weight: bold; background: rgba(0,0,0,0.3); padding: 8px 16px; border-radius: 8px; }
        #saldo { color: var(--warn); }
        #totalApuesta { color: var(--ok); }
        .controls { margin-top: 15px; }
        .fichas { margin-top: 15px; background: rgba(0,0,0,0.2); border-radius: 12px; padding: 10px; }
        .chips-row { display: flex; gap: 8px; justify-content: center; flex-wrap: wrap; margin-top: 10px; }
        .chip {
            width: 50px; height: 50px; border-radius: 50%; cursor: pointer;
            display: flex; align-items: center; justify-content: center;
            font-weight: 700; font-size: 14px;
            color: #fff;
            box-shadow: 0 2px 5px rgba(0,0,0,0.5);
            transition: transform .15s, box-shadow .15s;
            border: 2px solid rgba(255,255,255,0.7);
        }
        .chip:hover { transform: scale(1.1); }
        .chip.selected { transform: scale(1.15); box-shadow: 0 0 15px var(--gold); }
        .chip[data-value="1"] { background: radial-gradient(#d32f2f, #a02020); }
        .chip[data-value="5"] { background: radial-gradient(#1976d2, #105a9c); }
        .chip[data-value="10"] { background: radial-gradient(#388e3c, #286c2b); }
        .chip[data-value="50"] { background: radial-gradient(#fbc02d, #c49b00); color: #333; }
        .chip[data-value="100"] { background: radial-gradient(#8e24aa, #6a1b9a); }
        .chip[data-value="500"] { background: radial-gradient(#5d4037, #4e342e); }
        .small { font-size: 12px; opacity: .8; margin-top: 12px; }
        .mesa-wrap { margin-top: 20px; text-align: center; width: 100%; }
        .historial {
            margin-top: 20px; background: rgba(0,0,0,0.2); border-radius: 12px; padding: 10px;
            max-height: 200px; overflow-y: auto; font-size: 14px;
            border: 1px solid rgba(212, 175, 55, 0.2);
        }
        #historialLista { list-style: none; padding-left: 0;}
        #historialLista li { padding: 4px 8px; border-bottom: 1px solid rgba(255,255,255,0.1); }
        #bubble {
            font-size: 1.3em; font-weight: bold; color: var(--gold);
            margin-top: 10px; min-height: 30px; transition: opacity .3s, transform .3s;
            text-shadow: 1px 1px 2px #000;
        }
        .tabla-ruleta {
            background: var(--table-bg); border: 4px solid var(--table-border);
            border-radius: 10px; padding: 10px; box-shadow: inset 0 0 20px rgba(0,0,0,0.6);
        }
        .tabla-ruleta table { border-collapse: separate; border-spacing: 4px; width: 100%; }
        .tabla-ruleta td {
            height: 55px; text-align: center; vertical-align: middle; border-radius: 5px; cursor: pointer;
            font-weight: 700; font-size: 18px; transition: all 0.15s;
            position: relative; border: 1px solid rgba(255,255,255,0.1);
            text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
        }
        .tabla-ruleta td:hover { transform: scale(1.05); z-index: 10; box-shadow: 0 0 15px var(--gold); }
        .tabla-ruleta td.red { background: var(--red); color: #fff; }
        .tabla-ruleta td.black { background: var(--black); color: #fff; }
        .tabla-ruleta td.green { background: var(--green); color: #fff; }
        .cero-cell { height: 177px !important; width: 65px; }
        .cero-cell span { transform: rotate(-90deg); display: block; font-size: 28px; }
        .external-cell { padding: 0; }
        .external-cell button {
            flex: 1; padding: 15px 0; font-weight: 700; background: var(--green);
            border: 1px solid rgba(255,255,255,0.1); color: var(--txt); border-radius: 5px;
            cursor: pointer; position: relative; width: 100%; height: 100%; margin: 0;
            transition: all 0.15s;
        }
        .external-cell button:hover { background-color: #3b9a3f; }
        .external-cell button.red { background: var(--red); }
        .external-cell button.black { background: var(--black); }
        
        .external-bets-layout {
            margin-top: 4px; border-collapse: separate; border-spacing: 4px; width: calc(100% - 72px); margin-left: auto;
        }
        .external-bets-layout td { padding: 0; vertical-align: middle; text-align: center; }
        .external-bets-layout button {
            width: 100%; height: 55px; margin: 0; border-radius: 5px; font-weight: 700;
            background: var(--green); border: 1px solid rgba(255,255,255,0.1);
            color: var(--txt); transition: all 0.15s; font-size: 16px; text-transform: uppercase;
            position: relative;
        }
        .external-bets-layout button:hover { transform: none; box-shadow: 0 0 15px var(--gold); }
        .external-bets-layout button.red { background-color: var(--red); }
        .external-bets-layout button.black { background-color: var(--black); }

        .badge {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: auto; padding: 4px 8px; border-radius: 12px;
            background: rgba(255, 255, 10, 0.95);
            color: #000; display: flex; justify-content: center; align-items: center;
            font-size: 11px; box-shadow: 0 0 8px #000; pointer-events: none; font-weight: bold;
            border: 1px solid #fff;
        }
        #resultado { font-size: 1.5em; margin-top: 10px; font-weight: bold; }
    </style>
</head>
<body>
    <h1>üé∞ Ruleta Europea Deluxe</h1>
    <div id="croupierSelectWrap" class="row">
        <label for="croupierSelect">üé© Elige Croupier:</label>
        <select id="croupierSelect">
            <option value="">--Selecciona--</option>
            <option value="Fino">Fino</option>
            <option value="Vini">Vini</option>
            <option value="Maria">Maria</option>
        </select>
        <button id="confirmCroupier">Confirmar</button>
        <button id="resetAll" class="ghost">Reiniciar</button>
    </div>

    <div class="wrap" id="gameWrap">
        <div class="top-wrap">
            <div class="ruleta-panel">
                 <div class="ruleta-area">
                    <canvas id="ruleta" width="500" height="500" aria-label="Ruleta"></canvas>
                    <div id="croupierDisplay" class="croupier-display">
                        <img id="croupierImage" src="" alt="Croupier">
                    </div>
                </div>
                <div id="bubble" aria-live="polite">Selecciona un croupier para empezar</div>
                <div id="resultado" aria-live="polite"></div>
                <div class="status">
                    <div id="saldo">üí∞ Saldo: 1000 ‚Ç¨</div>
                    <div id="totalApuesta">Apostado: 0 ‚Ç¨</div>
                </div>
                <div class="controls">
                    <button id="spin">üé∞ Girar</button>
                    <button id="volverTirar" class="secondary">üîÑ Repetir</button>
                    <button id="duplicarApuestas" class="secondary">‚úñÔ∏è2 Duplicar</button>
                    <button id="quitarUltima" class="ghost">‚èÆÔ∏è Deshacer</button>
                    <button id="quitarTodas" class="ghost">üóëÔ∏è Limpiar</button>
                </div>
                <div class="fichas">
                    <h3>üí∞ Fichas</h3>
                    <div class="chips-row">
                        <div class="chip selected" data-value="1">1‚Ç¨</div>
                        <div class="chip" data-value="5">5‚Ç¨</div>
                        <div class="chip" data-value="10">10‚Ç¨</div>
                        <div class="chip" data-value="50">50‚Ç¨</div>
                        <div class="chip" data-value="100">100‚Ç¨</div>
                        <div class="chip" data-value="500">500‚Ç¨</div>
                    </div>
                    <div class="small">M√°x 1000‚Ç¨ por casilla, 5000‚Ç¨ por ronda.</div>
                </div>
            </div>
        </div>

        <div class="mesa-wrap">
            <div class="tabla-ruleta">
                <table>
                    <tbody>
                        <tr>
                            <td rowspan="3" data-num="0" class="green cero-cell"><span>0</span></td>
                            <td data-num="3" class="red">3</td><td data-num="6" class="black">6</td><td data-num="9" class="red">9</td>
                            <td data-num="12" class="red">12</td><td data-num="15" class="black">15</td><td data-num="18" class="red">18</td>
                            <td data-num="21" class="red">21</td><td data-num="24" class="black">24</td><td data-num="27" class="red">27</td>
                            <td data-num="30" class="red">30</td><td data-num="33" class="black">33</td><td data-num="36" class="red">36</td>
                            <td class="external-cell"><button data-bet-type="columna" data-bet-key="3">1¬™ Fila</button></td>
                        </tr>
                        <tr>
                            <td data-num="2" class="black">2</td><td data-num="5" class="red">5</td><td data-num="8" class="black">8</td>
                            <td data-num="11" class="black">11</td><td data-num="14" class="red">14</td><td data-num="17" class="black">17</td>
                            <td data-num="20" class="black">20</td><td data-num="23" class="red">23</td><td data-num="26" class="black">26</td>
                            <td data-num="29" class="black">29</td><td data-num="32" class="red">32</td><td data-num="35" class="black">35</td>
                             <td class="external-cell"><button data-bet-type="columna" data-bet-key="2">2¬™ Fila</button></td>
                        </tr>
                        <tr>
                            <td data-num="1" class="red">1</td><td data-num="4" class="black">4</td><td data-num="7" class="red">7</td>
                            <td data-num="10" class="black">10</td><td data-num="13" class="black">13</td><td data-num="16" class="red">16</td>
                            <td data-num="19" class="red">19</td><td data-num="22" class="black">22</td><td data-num="25" class="red">25</td>
                            <td data-num="28" class="black">28</td><td data-num="31" class="black">31</td><td data-num="34" class="red">34</td>
                             <td class="external-cell"><button data-bet-type="columna" data-bet-key="1">3¬™ Fila</button></td>
                        </tr>
                    </tbody>
                </table>
                <table class="external-bets-layout">
                     <tbody>
                        <tr>
                            <td colspan="4"><button data-bet-type="docena" data-bet-key="1">1¬™ Docena</button></td>
                            <td colspan="4"><button data-bet-type="docena" data-bet-key="2">2¬™ Docena</button></td>
                            <td colspan="4"><button data-bet-type="docena" data-bet-key="3">3¬™ Docena</button></td>
                        </tr>
                        <tr>
                            <td colspan="2"><button data-bet-type="mitad" data-bet-key="bajo">1-18</button></td>
                            <td colspan="2"><button data-bet-type="paridad" data-bet-key="par">PAR</button></td>
                            <td colspan="2"><button data-bet-type="color" data-bet-key="rojo" class="red">Rojo</button></td>
                            <td colspan="2"><button data-bet-type="color" data-bet-key="negro" class="black">Negro</button></td>
                            <td colspan="2"><button data-bet-type="paridad" data-bet-key="impar">IMPAR</button></td>
                            <td colspan="2"><button data-bet-type="mitad" data-bet-key="alto">19-36</button></td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
        <div class="historial">
            <h3>üßæ Historial de Jugadas</h3>
            <ul id="historialLista"></ul>
        </div>
    </div>

<script>
(function(){
    const canvas = document.getElementById("ruleta"), ctx = canvas.getContext("2d");
    const W = canvas.width, H = canvas.height, cx = W / 2, cy = H / 2;
    const nums = [0, 32, 15, 19, 4, 21, 2, 25, 17, 34, 6, 27, 13, 36, 11, 30, 8, 23, 10, 5, 24, 16, 33, 1, 20, 14, 31, 9, 22, 18, 29, 7, 28, 12, 35, 3, 26];
    const reds = new Set([1, 3, 5, 7, 9, 12, 14, 16, 18, 19, 21, 23, 25, 27, 30, 32, 34, 36]);
    const sector = 2 * Math.PI / nums.length;
    let bolaAng = 0, spinning = false, croupier = '';
    let saldo = parseInt(localStorage.getItem("saldo_ruleta") || "1000", 10), selChip = 1;
    let apuestas = new Map();
    let historialApuestas = [];
    let ultimaApuesta = new Map();
    const MAX_APUESTA_CASILLA = 1000, MAX_APUESTA_RONDA = 5000;

    const croupiers = {
        'Fino': { img: './images.jpg' },
        'Vini': { img: './vini.jpg' },
        'Maria': { img: './pancha.webp' }
    };

    const bubbleEl = document.getElementById("bubble"), saldoEl = document.getElementById("saldo");
    const totalApuestaEl = document.getElementById("totalApuesta"), resEl = document.getElementById("resultado");
    const spinBtn = document.getElementById("spin"), histList = document.getElementById("historialLista");
    const gameWrap = document.getElementById("gameWrap");
    const betElements = document.querySelectorAll('[data-num], [data-bet-type]');
    const croupierDisplay = document.getElementById('croupierDisplay');
    const croupierImage = document.getElementById('croupierImage');

    function decir(msg, duracion = 4000) {
        bubbleEl.textContent = msg;
        bubbleEl.style.opacity = 1;
        bubbleEl.style.transform = 'translateY(0)';
        setTimeout(() => {
            bubbleEl.style.opacity = 0;
            bubbleEl.style.transform = 'translateY(-10px)';
        }, duracion);
    }
    
    function actualizarSaldoUI() {
        saldoEl.textContent = `üí∞ Saldo: ${saldo} ‚Ç¨`;
        localStorage.setItem("saldo_ruleta", saldo);
    }

    function actualizarTotalApostadoUI() {
        const total = Array.from(apuestas.values()).reduce((sum, bet) => sum + bet.amt, 0);
        totalApuestaEl.textContent = `Apostado: ${total} ‚Ç¨`;
        return total;
    }

    function toggleControles(disabled) {
        spinning = disabled;
        document.querySelectorAll("button, .chip, [data-num], [data-bet-type], select").forEach(e => {
             if (e.id !== 'resetAll' && e.id !== 'confirmCroupier') {
                e.disabled = disabled;
            }
        });
    }
    
    function renderizarBadge(el, valor) {
        let badge = el.querySelector(".badge");
        if (!badge) {
            badge = document.createElement("span");
            badge.className = "badge";
            el.appendChild(badge);
        }
        badge.textContent = `${valor}‚Ç¨`;
    }

    function limpiarBadge(el) {
        const badge = el.querySelector(".badge");
        if (badge) badge.remove();
    }
    
    function limpiarTodosLosBadges() {
        document.querySelectorAll('.badge').forEach(b => b.remove());
    }

    function anadirHistorial(msg) {
        const li = document.createElement("li");
        li.innerHTML = msg;
        histList.prepend(li);
        if (histList.childElementCount > 50) histList.removeChild(histList.lastChild);
    }
    
    function drawWheel(){
        ctx.clearRect(0, 0, W, H);
        const r = W / 2;

        const woodGradient = ctx.createRadialGradient(cx, cy, r - 40, cx, cy, r);
        woodGradient.addColorStop(0, '#8c5a2b');
        woodGradient.addColorStop(1, '#593a1a');
        ctx.fillStyle = woodGradient;
        ctx.beginPath();
        ctx.arc(cx, cy, r, 0, 2 * Math.PI);
        ctx.fill();

        const innerRadius = r - 20;

        nums.forEach((n, i) => {
            const a0 = i * sector, a1 = a0 + sector;
            ctx.beginPath();
            ctx.moveTo(cx, cy);
            ctx.arc(cx, cy, innerRadius, a0, a1);
            ctx.closePath();
            ctx.fillStyle = n === 0 ? "#2e7d32" : reds.has(n) ? "#d32f2f" : "#1a1a1a";
            ctx.fill();
            
            ctx.save();
            ctx.translate(cx, cy);
            ctx.rotate((a0 + a1) / 2);
            ctx.fillStyle = "#fff";
            ctx.font = "bold 18px Poppins";
            ctx.textAlign = "right";
            ctx.textBaseline = "middle";
            ctx.fillText(n, innerRadius - 15, 0);
            ctx.restore();
        });

        ctx.strokeStyle = '#d4af37';
        ctx.lineWidth = 2;
        nums.forEach((n, i) => {
             const a0 = i * sector;
             ctx.save();
             ctx.translate(cx,cy);
             ctx.rotate(a0);
             ctx.beginPath();
             ctx.moveTo(innerRadius - 40, 0);
             ctx.lineTo(innerRadius, 0);
             ctx.stroke();
             ctx.restore();
        });

        const centerRadius = 60;
        const centerGrad = ctx.createRadialGradient(cx, cy, 0, cx, cy, centerRadius);
        centerGrad.addColorStop(0, '#666');
        centerGrad.addColorStop(0.8, '#333');
        centerGrad.addColorStop(1, '#111');
        ctx.fillStyle = centerGrad;
        ctx.beginPath();
        ctx.arc(cx, cy, centerRadius, 0, 2 * Math.PI);
        ctx.fill();
        
        ctx.fillStyle = 'rgba(255,255,255,0.1)';
        ctx.beginPath();
        ctx.arc(cx - 15, cy - 20, 40, 0, 2 * Math.PI);
        ctx.fill();

        const ballRadius = r - 60;
        const x = cx + Math.cos(-bolaAng) * ballRadius;
        const y = cy + Math.sin(-bolaAng) * ballRadius;
        const ballGrad = ctx.createRadialGradient(x-3, y-3, 1, x, y, 12);
        ballGrad.addColorStop(0, '#fff');
        ballGrad.addColorStop(1, '#ccc');
        ctx.fillStyle = ballGrad;
        ctx.beginPath();
        ctx.arc(x, y, 12, 0, 2 * Math.PI);
        ctx.fill();
    }

    function getNumeroDesdeAngulo() {
      let anguloNormalizado = (-bolaAng + sector / 2) % (2 * Math.PI);
      if (anguloNormalizado < 0) anguloNormalizado += 2 * Math.PI;
      const indice = Math.floor(anguloNormalizado / sector);
      return nums[indice];
    }
    
    function animarGiro() {
        let vueltas = 8 + Math.random() * 4;
        let duracion = 5000 + Math.random() * 3000;
        let anguloInicial = bolaAng;
        let desplazamientoTotal = (vueltas * 2 * Math.PI) + (Math.random() * 2 * Math.PI);
        let tiempoInicio = Date.now();

        function frame() {
            let tiempoTranscurrido = Date.now() - tiempoInicio;
            let progreso = tiempoTranscurrido / duracion;
            if (progreso >= 1) {
                bolaAng = anguloInicial + desplazamientoTotal;
                drawWheel();
                const numeroGanador = getNumeroDesdeAngulo();
                finalizarRonda(numeroGanador);
                return;
            }
            let easeOut = 1 - Math.pow(1 - progreso, 4);
            bolaAng = anguloInicial + easeOut * desplazamientoTotal;
            drawWheel();
            requestAnimationFrame(frame);
        }
        requestAnimationFrame(frame);
    }

    function finalizarRonda(n) {
      const colorHex = n === 0 ? 'var(--ok)' : reds.has(n) ? 'var(--err)' : 'var(--txt)';
      resEl.innerHTML = `üéâ N√∫mero: <strong style="color:${colorHex}; font-size:1.2em;">${n}</strong>`;
      let ganancia = 0;
      let totalPerdido = actualizarTotalApostadoUI();
      apuestas.forEach(apuesta => {
        let { type, key, amt } = apuesta;
        let esGanadora = false;
        if (type === "numero") { esGanadora = (Number(key) === n); }
        else if (n !== 0) {
          if (type === "color") { esGanadora = (key === "rojo" ? reds.has(n) : !reds.has(n)); }
          if (type === "paridad") { esGanadora = (key === "par" ? n % 2 === 0 : n % 2 !== 0); }
          if (type === "mitad") { esGanadora = (key === "bajo" ? n >= 1 && n <= 18 : n >= 19 && n <= 36); }
          if (type === "docena") { esGanadora = (Number(key) === Math.ceil(n / 12)); }
          if (type === "columna") {
            const col = n % 3;
            const targetCol = Number(key);
            if ((col === 1 && targetCol === 1) || (col === 2 && targetCol === 2) || (col === 0 && targetCol === 3)) {
                esGanadora = true;
            }
          }
        }
        if (esGanadora) {
          let multiplicador = type === "numero" ? 36 : (type === "docena" || type === "columna") ? 3 : 2;
          ganancia += amt * multiplicador;
        }
      });
      
      saldo += ganancia;
      actualizarSaldoUI();
      let gananciaNeta = ganancia - totalPerdido;
      if (ganancia > 0) {
        decir(`üèÜ ¬°Ganaste ${ganancia} ‚Ç¨!`);
        anadirHistorial(`‚úÖ ${n} (Ganancia neta: <span style="color:var(--ok);">+${gananciaNeta} ‚Ç¨</span>)`);
      } else {
        decir(`ü§î ${croupier} dice: "Mejor suerte la pr√≥xima vez."`);
        anadirHistorial(`‚ùå ${n} (P√©rdida: <span style="color:var(--err);">${-totalPerdido} ‚Ç¨</span>)`);
      }
      ultimaApuesta = new Map(apuestas);
      apuestas.clear();
      historialApuestas = [];
      limpiarTodosLosBadges();
      actualizarTotalApostadoUI();
      toggleControles(false);
    }

    spinBtn.addEventListener("click", () => {
      const totalApostado = actualizarTotalApostadoUI();
      if (spinning || totalApostado === 0) return;
      toggleControles(true);
      decir(`üé≤ ${croupier} dice: "¬°No va m√°s!"`);
      resEl.textContent = "Girando...";
      animarGiro();
    });
    
    betElements.forEach(el => {
      const targetElement = el.tagName === 'BUTTON' ? el : el;
      const type = targetElement.dataset.num ? 'numero' : targetElement.dataset.betType;
      const key = targetElement.dataset.num || targetElement.dataset.betKey;
      if (!type) return;
      
      targetElement.dataset.betId = `${type}-${key}`;
      
      targetElement.addEventListener("click", () => {
        if (spinning) return;
        const totalApostado = actualizarTotalApostadoUI();
        const amt = selChip;
        if (saldo < amt) { decir("‚ùå Saldo insuficiente."); return; }
        if (totalApostado + amt > MAX_APUESTA_RONDA) { decir("‚ùå L√≠mite de apuesta por ronda superado."); return; }
        const betId = targetElement.dataset.betId;
        const apuestaActual = apuestas.get(betId) || { type, key, amt: 0, el: targetElement };
        if (apuestaActual.amt + amt > MAX_APUESTA_CASILLA) { decir("‚ùå L√≠mite de apuesta por casilla superado."); return; }
        
        apuestaActual.amt += amt;
        apuestas.set(betId, apuestaActual);
        historialApuestas.push({ betId, amt });
        saldo -= amt;
        actualizarSaldoUI();
        renderizarBadge(targetElement, apuestaActual.amt);
        actualizarTotalApostadoUI();
      });
    });

    document.querySelectorAll(".chip").forEach(c => c.addEventListener("click", () => {
      if (spinning) return;
      selChip = Number(c.dataset.value);
      document.querySelectorAll(".chip").forEach(x => x.classList.remove("selected"));
      c.classList.add("selected");
    }));

    document.getElementById("quitarUltima").addEventListener("click", () => {
      if (spinning || historialApuestas.length === 0) return;
      const ultimaAccion = historialApuestas.pop();
      const { betId, amt } = ultimaAccion;
      const apuesta = apuestas.get(betId);
      if (apuesta) {
        apuesta.amt -= amt;
        saldo += amt;
        if (apuesta.amt <= 0) {
          apuestas.delete(betId);
          limpiarBadge(apuesta.el);
        } else {
          renderizarBadge(apuesta.el, apuesta.amt);
        }
        actualizarSaldoUI();
        actualizarTotalApostadoUI();
        anadirHistorial(`‚Ü©Ô∏è Deshacer apuesta de ${amt}‚Ç¨`);
      }
    });

    document.getElementById("quitarTodas").addEventListener("click", () => {
      if (spinning || apuestas.size === 0) return;
      const totalReembolsado = actualizarTotalApostadoUI();
      saldo += totalReembolsado;
      apuestas.clear();
      historialApuestas = [];
      limpiarTodosLosBadges();
      actualizarSaldoUI();
      actualizarTotalApostadoUI();
      anadirHistorial("üóëÔ∏è Todas las apuestas han sido retiradas.");
    });

    document.getElementById("duplicarApuestas").addEventListener("click", () => {
      const totalApostado = actualizarTotalApostadoUI();
      if (spinning || totalApostado === 0) return;
      if (saldo < totalApostado) { decir("‚ùå Saldo insuficiente para duplicar."); return; }
      if (totalApostado * 2 > MAX_APUESTA_RONDA) { decir("‚ùå Duplicar excede el l√≠mite de la ronda."); return; }
      let puedeDuplicar = true;
      apuestas.forEach(apuesta => { if (apuesta.amt * 2 > MAX_APUESTA_CASILLA) puedeDuplicar = false; });
      if (!puedeDuplicar) { decir("‚ùå Duplicar excede el l√≠mite de una casilla."); return; }

      saldo -= totalApostado;
      apuestas.forEach((apuesta, betId) => {
        historialApuestas.push({ betId, amt: apuesta.amt });
        apuesta.amt *= 2;
        renderizarBadge(apuesta.el, apuesta.amt);
      });
      actualizarSaldoUI();
      actualizarTotalApostadoUI();
      anadirHistorial(`‚úñÔ∏è2 Apuestas duplicadas.`);
    });
    
    document.getElementById("volverTirar").addEventListener("click", () => {
        if(spinning || ultimaApuesta.size === 0) return;
        const totalUltimaApuesta = Array.from(ultimaApuesta.values()).reduce((sum, bet) => sum + bet.amt, 0);
        if(saldo < totalUltimaApuesta) { decir("‚ùå Saldo insuficiente para repetir la apuesta."); return; }
        
        document.getElementById("quitarTodas").click();
        
        ultimaApuesta.forEach((apuesta, betId) => {
            const { type, key, amt, el } = apuesta;
            apuestas.set(betId, { type, key, amt, el });
            historialApuestas.push({ betId, amt });
            saldo -= amt;
            renderizarBadge(el, amt);
        });
        actualizarSaldoUI();
        actualizarTotalApostadoUI();
        anadirHistorial("üîÑ Apostando lo mismo que la ronda anterior.");
    });

    document.getElementById("confirmCroupier").addEventListener("click", () => {
      const select = document.getElementById("croupierSelect");
      if (!select.value) { alert("Por favor, selecciona un croupier."); return; }
      croupier = select.value;
      const croupierInfo = croupiers[croupier];
      if (croupierInfo) {
          croupierImage.src = croupierInfo.img;
          croupierImage.alt = `Croupier ${croupier}`;
          croupierDisplay.style.display = 'block';
      }
      document.getElementById("croupierSelectWrap").style.display = "none";
      gameWrap.style.display = "block";
      decir(`üé© ${croupier} te da la bienvenida. ¬°Hagan sus apuestas!`);
    });

    document.getElementById("resetAll").addEventListener("click", () => {
      if (!confirm("¬øEst√°s seguro de que quieres reiniciar todo el juego? Se perder√° tu saldo guardado.")) return;
      localStorage.removeItem("saldo_ruleta");
      location.reload();
    });

    // Estado inicial
    drawWheel();
    actualizarSaldoUI();
    actualizarTotalApostadoUI();
    gameWrap.style.display = "none";
    document.getElementById("croupierSelectWrap").style.display = "flex";
})();
</script>
</body>
</html>
